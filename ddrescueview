#!/usr/bin/nodejs

var fs = require('fs');
var filesize = require('filesize');
var logParser = require('./logParser');
var viewBuilder = require('./viewBuilder');

var rows = process.argv[3] || Math.floor(process.stdout.rows/2);
var granules = rows * process.stdout.columns;

fs.readFile(process.argv[2], 'utf8', function(err, data) {
    if (err) {
        return console.log(err);
    }

    var log = logParser.readString(data);
    var logEntries = log.entries;
    var totalSize = log.totalSize;

    var sizeBreakdown = viewBuilder.sizeSummary(log);

    var logString = viewBuilder.linearVisual(log, granules);
    var step = totalSize/granules;

    console.log("granule size:\t" + filesize(step));
    console.log("row size:\t" + filesize(step * process.stdout.columns));
    console.log(viewBuilder.legendLine(step));
    for (var flag in sizeBreakdown) {
        console.log(flag + ": " + filesize(sizeBreakdown[flag]));
    }
    console.log(logString);
});
