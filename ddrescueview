#!/usr/bin/nodejs

var fs = require('fs');
var filesize = require('filesize');
var logParser = require('./logParser');
var viewBuilder = require('./viewBuilder');

var granules = process.argv[3];

var legendLine = function(step, size, legend) {
    var result = legend + ":\t";
    for (var i = 0; i < Math.round(size/step); i++) {
        result += "-";
    }
    return result;
}

fs.readFile(process.argv[2], 'utf8', function(err, data) {
    if (err) {
        return console.log(err);
    }

    var log = logParser.readString(data);
    var logEntries = log.entries;
    var totalSize = log.totalSize;

    var sizeBreakdown = logEntries.reduce(function(sizeBreakdown, logEntry) {
        if (!(logEntry.flag in sizeBreakdown)) {
            sizeBreakdown[logEntry.flag] = 0;
        }
        sizeBreakdown[logEntry.flag] += logEntry.size;
        return sizeBreakdown;
    }, {});

    var logString = viewBuilder.linearVisual(log, granules);
    var step = totalSize/granules;

    console.log("granule size is " + filesize(step));
    console.log(legendLine(step, 1024 * 1024 * 1024, "GiB"));
    for (var flag in sizeBreakdown) {
        console.log(flag + ": " + filesize(sizeBreakdown[flag]));
    }
    console.log(logString);
});
